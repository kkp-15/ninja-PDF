<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ğŸ“„ å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ï½œPDFã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç”¨é€”åˆ¥ï¼‰</title>
<meta name="description" content="ã‚«ãƒ¡ãƒ©èµ·å‹•â†’æ’®å½±/å–è¾¼ã¿â†’ä¸¦ã¹æ›¿ãˆâ†’PDFä½œæˆâ†’ä¿å­˜/å…±æœ‰ã€‚1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµãƒ»ç«¯æœ«å†…å‡¦ç†ã€‚">
<style>
  :root { color-scheme: light dark; --gap:12px; }
  *{box-sizing:border-box}
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0}
  header{position:sticky;top:0;z-index:10;padding:12px 16px;background:color-mix(in oklab, Canvas 85%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent)}
  h1{margin:0 0 4px;font-size:18px}
  .sub{font-size:12px;opacity:.8}
  .wrap{padding:16px;display:grid;gap:var(--gap)}
  .row{display:grid;gap:8px;grid-template-columns:1fr 1fr}
  select,button,input[type="number"],input[type="text"],input[type="file"]{padding:10px;font-size:14px;border-radius:10px;border:1px solid color-mix(in oklab, CanvasText 15%, transparent)}
  button{background:color-mix(in oklab, Canvas 90%, transparent)}
  button:disabled{opacity:.5}
  video{width:100%;max-height:50vh;object-fit:cover;border-radius:12px;background:#000}
  .tools{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .card{position:relative;border:1px solid color-mix(in oklab, CanvasText 15%, transparent);border-radius:10px;overflow:hidden}
  .card img{width:100%;height:120px;object-fit:cover;display:block}
  .card .btns{position:absolute;left:0;right:0;bottom:0;display:flex;gap:4px;justify-content:center;background:color-mix(in oklab, Canvas 70%, transparent);padding:6px}
  .hint{font-size:12px;opacity:.8}
  .ok{color:#0a7a27}
  .danger{color:#b00020}
  footer{padding:12px 16px;font-size:12px;opacity:.8}
</style>
<!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼šPDFç”Ÿæˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ©ç”¨æƒ³å®šï¼‰ã€‚å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ã—ãŸã„å ´åˆã¯PWAåŒ–ã‹ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ä¸Šã§åˆ©ç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <h1>ğŸ“„ PDFã‚¹ã‚­ãƒ£ãƒ³ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h1>
  <div class="sub">ç”¨é€”åˆ¥ãƒ—ãƒªã‚»ãƒƒãƒˆã§æœ€çŸ­ä½œæˆã€‚ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—ï¼ˆç«¯æœ«å†…å‡¦ç†ï¼‰ã€‚</div>
</header>

<div class="wrap">
  <section class="row" style="align-items:center;">
    <label>ãƒ¢ãƒ¼ãƒ‰
      <select id="mode">
        <option value="submit">æå‡ºç”¨ï¼ˆA4ï¼‰</option>
        <option value="receipt">ãƒ¬ã‚·ãƒ¼ãƒˆæŸã­ï¼ˆçµŒè²»ï¼‰</option>
        <option value="school">å­¦æ ¡ãƒ—ãƒªãƒ³ãƒˆå…±æœ‰</option>
      </select>
    </label>
    <input id="title" type="text" placeholder="ä»¶å/ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰" />
  </section>

  <section class="tools">
    <button id="startCam">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="shot" disabled>ğŸ“· æ’®å½±ï¼ˆ1æšè¿½åŠ ï¼‰</button>
    <input id="pick" type="file" accept="image/*" capture="environment" multiple style="grid-column: span 2;" />
  </section>

  <video id="video" playsinline autoplay muted></video>

  <section>
    <div class="row">
      <label>ç”¨ç´™ã‚µã‚¤ã‚º
        <select id="paper">
          <option value="A4">A4 ç¸¦</option>
          <option value="Letter">Letter ç¸¦</option>
        </select>
      </label>
      <label>é•·è¾ºãƒ”ã‚¯ã‚»ãƒ«
        <input id="maxPx" type="number" min="1000" max="4000" step="100" value="2000" />
      </label>
      <label>JPEGå“è³ªï¼ˆ0.5â€“0.95ï¼‰
        <input id="quality" type="number" min="0.5" max="0.95" step="0.05" value="0.8" />
      </label>
      <label>
        <input id="bw" type="checkbox" checked /> ç™½é»’å¼·èª¿ï¼ˆè»½é‡åŒ–ï¼‰
      </label>
    </div>
    <div class="hint">ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã§æ¨å¥¨å€¤ãŒè‡ªå‹•ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</div>
  </section>

  <section>
    <h3 style="margin:0 0 6px;">ğŸ“‘ ãƒšãƒ¼ã‚¸ï¼ˆä¸¦ã¹æ›¿ãˆ/å‰Šé™¤ï¼‰</h3>
    <div id="thumbs" class="grid"></div>
    <div class="hint">â†‘â†“ã§é †ç•ªå¤‰æ›´ãƒ»å‰Šé™¤å¯ã€‚â€œå‰Šé™¤â†’å…ƒã«æˆ»ã™â€ã«ã‚‚å¯¾å¿œã€‚</div>
  </section>

  <section class="tools">
    <button id="clear" class="danger">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    <button id="make" class="ok">ğŸ§¾ PDFä½œæˆ</button>
  </section>

  <div id="after" style="display:none;">
    <div class="hint">PDFã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä¿å­˜ã¾ãŸã¯å…±æœ‰ã§ãã¾ã™ã€‚</div>
    <div class="tools">
      <a id="dl" class="ok" download>â¬‡ï¸ ç«¯æœ«ã«ä¿å­˜</a>
      <button id="share">ğŸ¤ å…±æœ‰</button>
    </div>
  </div>

  <div id="toast" class="hint"></div>
</div>

<footer>
  <div>â€»PWA/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èµ·å‹•ã¯åˆ¥é€”Service Workerã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ä¸å¯ï¼‰ã€‚</div>
</footer>

<script>
(() => {
  const { jsPDF } = window.jspdf;

  // â€”â€” ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ—ãƒªã‚»ãƒƒãƒˆ â€”â€”
  const MODES = {
    submit:  { paper:'A4', maxPx:2000, q:0.8,  bw:true,  pageNo:true,  name:(t)=>fmtDate()+`_æå‡º_${t||'æ›¸é¡'}.pdf` },
    receipt: { paper:'A4', maxPx:1600, q:0.75, bw:true,  pageNo:true,  name:()=>fmtYM()+`_çµŒè²»_æŸã­.pdf` },
    school:  { paper:'A4', maxPx:1800, q:0.8,  bw:true,  pageNo:true,  name:(t)=>fmtDate()+`_${t||'å­¦æ ¡'}.pdf` },
  };

  // â€”â€” è¦ç´ å–å¾— â€”â€”
  const $ = (id)=>document.getElementById(id);
  const modeSel=$('mode'), titleEl=$('title'), startBtn=$('startCam'), shotBtn=$('shot'), pick=$('pick');
  const video=$('video'), thumbs=$('thumbs'), clearBtn=$('clear'), makeBtn=$('make'), toast=$('toast');
  const after=$('after'), dl=$('dl'), shareBtn=$('share');
  const paperSel=$('paper'), maxPxEl=$('maxPx'), qEl=$('quality'), bwEl=$('bw');

  let pages=[];       // dataURL(JPEG)é…åˆ—
  let stream=null;    // ã‚«ãƒ¡ãƒ©
  let undo=null;      // æœ€å¾Œã«å‰Šé™¤ã—ãŸè¦ç´ 
  let lastBlob=null;  // ç”ŸæˆPDF
  let lastName='';

  // åˆæœŸãƒ¢ãƒ¼ãƒ‰
  applyMode('submit');
  modeSel.addEventListener('change', ()=>applyMode(modeSel.value));
  function applyMode(key){
    const m=MODES[key]; if(!m) return;
    paperSel.value=m.paper; maxPxEl.value=m.maxPx; qEl.value=m.q; bwEl.checked=m.bw;
    toastMsg(`ãƒ¢ãƒ¼ãƒ‰é©ç”¨ï¼š${modeSel.options[modeSel.selectedIndex].text}`);
  }

  // â€”â€” ã‚«ãƒ¡ãƒ© â€”â€”
  startBtn.addEventListener('click', startCam);
  window.addEventListener('beforeunload', stopCam);
  async function startCam(){
    stopCam();
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      video.srcObject=stream; shotBtn.disabled=false; toastMsg('ã‚«ãƒ¡ãƒ©èµ·å‹•');
    }catch(e){ console.error(e); toastMsg('ã‚«ãƒ¡ãƒ©ä¸å¯ã€‚ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'); }
  }
  function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; shotBtn.disabled=true; }}

  // â€”â€” æ’®å½± â†’ 1ãƒšãƒ¼ã‚¸è¿½åŠ  â€”â€”
  shotBtn.addEventListener('click', ()=>{
    if(!stream) return;
    const tr=stream.getVideoTracks()[0]; const s=tr.getSettings();
    const vw=video.videoWidth||s.width||1920, vh=video.videoHeight||s.height||1080;
    const cv=document.createElement('canvas'); cv.width=vw; cv.height=vh;
    cv.getContext('2d').drawImage(video,0,0,vw,vh);
    addPageFromCanvas(cv);
  });

  // â€”â€” ç”»åƒå–è¾¼ã¿ï¼ˆEXIFå›è»¢å¯¾å¿œï¼‰ â€”â€”
  pick.addEventListener('change', async (e)=>{
    const files=[...e.target.files]; if(!files.length) return;
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      const bmp=await createImageBitmap(f,{imageOrientation:'from-image'}); // EXIFã«å¾“ã£ã¦æ­£ã—ã„å‘ãã§ç”Ÿæˆ
      const cv=document.createElement('canvas'); cv.width=bmp.width; cv.height=bmp.height;
      cv.getContext('2d').drawImage(bmp,0,0); bmp.close?.();
      addPageFromCanvas(cv);
    }
  });

  // â€”â€” ãƒšãƒ¼ã‚¸åŒ–ï¼ˆç¸®å°â†’ç™½é»’å¼·èª¿â†’JPEGåŒ–ï¼‰ â€”â€”
  function addPageFromCanvas(srcCv){
    const maxPx=+maxPxEl.value||2000; const q=+qEl.value||0.8;
    const scale=Math.min(1, maxPx/Math.max(srcCv.width, srcCv.height));
    const w=Math.round(srcCv.width*scale), h=Math.round(srcCv.height*scale);
    const cv=document.createElement('canvas'); cv.width=w; cv.height=h; const ctx=cv.getContext('2d');
    ctx.drawImage(srcCv,0,0,w,h);
    if(bwEl.checked){ // è»½é‡ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
      const img=ctx.getImageData(0,0,w,h), d=img.data; for(let i=0;i<d.length;i+=4){
        const y=d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114; d[i]=d[i+1]=d[i+2]=y;
      } ctx.putImageData(img,0,0);
    }
    const url=cv.toDataURL('image/jpeg', q);
    pages.push(url); renderThumbs(); toastMsg(`è¿½åŠ ï¼š${pages.length}ãƒšãƒ¼ã‚¸`);
  }

  // â€”â€” ã‚µãƒ ãƒUI â€”â€”
  function renderThumbs(){
    thumbs.innerHTML='';
    pages.forEach((src,i)=>{
      const card=document.createElement('div'); card.className='card';
      const img=document.createElement('img'); img.src=src; card.appendChild(img);
      const btns=document.createElement('div'); btns.className='btns';
      const up=btn('â†‘',()=>{ if(i>0){ [pages[i-1],pages[i]]=[pages[i],pages[i-1]]; renderThumbs(); } });
      const dn=btn('â†“',()=>{ if(i<pages.length-1){ [pages[i+1],pages[i]]=[pages[i],pages[i+1]]; renderThumbs(); } });
      const del=btn('å‰Šé™¤',()=>{ undo={i,data:pages[i]}; pages.splice(i,1); renderThumbs(); toastMsg('å‰Šé™¤ã—ã¾ã—ãŸ','å…ƒã«æˆ»ã™',undoDel); });
      btns.append(up,dn,del); card.appendChild(btns); thumbs.appendChild(card);
    });
    after.style.display='none';
  }
  function btn(label, on){ const b=document.createElement('button'); b.textContent=label; b.onclick=on; return b; }
  function undoDel(){ if(!undo) return; pages.splice(undo.i,0,undo.data); undo=null; renderThumbs(); }

  clearBtn.addEventListener('click',()=>{ if(!pages.length) return; if(confirm('ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ pages=[]; renderThumbs(); toastMsg('å…¨å‰Šé™¤'); } });

  // â€”â€” PDFä½œæˆ â€”â€”
  makeBtn.addEventListener('click', async ()=>{
    if(!pages.length){ toastMsg('ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const size=(paperSel.value==='A4')?[595.28,841.89]:[612,792]; // pt A4/Letter
    const pdf=new jsPDF({orientation:'p', unit:'pt', format:size});
    const margin=24, W=size[0]-margin*2, H=size[1]-margin*2;
    const showPageNo=MODES[modeSel.value]?.pageNo;

    for(let i=0;i<pages.length;i++){
      if(i>0) pdf.addPage(size,'p');
      const {w:iw,h:ih}=await imgSize(pages[i]);
      const ir=iw/ih, wr=W/H; let dw,dh; if(ir>wr){ dw=W; dh=W/ir; } else { dh=H; dw=H*ir; }
      const x=(size[0]-dw)/2, y=(size[1]-dh)/2;
      pdf.addImage(pages[i],'JPEG',x,y,dw,dh,undefined,'FAST');
      if(showPageNo){ pdf.setFontSize(10); pdf.text(`${i+1}/${pages.length}`, size[0]-margin, size[1]-margin*0.6, {align:'right'}); }
    }

    lastName=autoName(); lastBlob=pdf.output('blob'); const url=URL.createObjectURL(lastBlob);
    dl.href=url; dl.download=lastName; after.style.display='block';
    // ç«¯æœ«ä¿å­˜ã‚’ã™ãè¡Œã†å ´åˆã¯æ¬¡è¡Œã‚’æœ‰åŠ¹åŒ–
    pdf.save(lastName);
    toastMsg('PDFã‚’ä½œæˆã—ã¾ã—ãŸ');
  });

  // â€”â€” å…±æœ‰ï¼ˆAndroidã®Web Share APIæƒ³å®šï¼‰ â€”â€”
  shareBtn.addEventListener('click', async ()=>{
    if(!lastBlob){ toastMsg('å…ˆã«PDFã‚’ä½œæˆã—ã¦ãã ã•ã„'); return; }
    const file=new File([lastBlob], lastName, {type:'application/pdf'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ title:lastName, files:[file] });
    }else{
      toastMsg('ã“ã®ç«¯æœ«ã¯Web Shareæœªå¯¾å¿œã§ã™ã€‚ä¿å­˜â†’ã‚¢ãƒ—ãƒªã§å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');
    }
  });

  // â€”â€” è£œåŠ©é–¢æ•° â€”â€”
  function autoName(){ const key=modeSel.value; const t=(titleEl.value||'').trim(); const fn=MODES[key]?.name; return (typeof fn==='function')? fn(t) : (fmtDate()+`_${t||'scan'}.pdf`); }
  function fmtDate(d=new Date()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}${m}${da}`; }
  function fmtYM(d=new Date()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'); return `${y}${m}`; }
  function toastMsg(text, actionText, action){ toast.textContent=''; toast.append(document.createTextNode(text)); if(actionText){ const b=document.createElement('button'); b.textContent=actionText; b.style.marginLeft='8px'; b.onclick=()=>{ action?.(); toast.textContent=''; }; toast.appendChild(b);} }
  function imgSize(url){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth||1, h:img.naturalHeight||1}); img.src=url; }); }
})();
</script>
</body>
</html>
