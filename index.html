<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PDFã‚¹ã‚­ãƒ£ãƒ³ï½œè¶…ã‚·ãƒ³ãƒ—ãƒ«</title>
<style>
  :root { color-scheme: light dark; --gap:12px; }
  *{box-sizing:border-box}
  html,body{max-width:100%;overflow-x:hidden}
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0}
  header,.wrap,footer{max-width:720px;margin-inline:auto}
  header{position:sticky;top:0;z-index:10;padding:12px 16px;background:color-mix(in oklab, Canvas 85%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent)}
  h1{margin:0;font-size:18px}
  .wrap{padding:16px;display:grid;gap:var(--gap)}
  button,input[type=file]{padding:12px;font-size:16px;border-radius:12px;border:1px solid color-mix(in oklab, CanvasText 15%, transparent);width:100%;background:color-mix(in oklab, Canvas 92%, transparent)}
  .row{display:grid;gap:var(--gap);grid-template-columns:1fr 1fr 1fr}
  @media (max-width:640px){ .row{grid-template-columns:1fr} }
  video{width:100%;max-height:42vh;object-fit:cover;border-radius:12px;background:#000}
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px,1fr));gap:8px}
  .card{position:relative;border:1px solid color-mix(in oklab, CanvasText 15%, transparent);border-radius:10px;overflow:hidden}
  .card img{width:100%;height:120px;object-fit:cover;display:block}
  .card .btns{position:absolute;inset:auto 0 0 0;display:flex;gap:6px;justify-content:center;background:color-mix(in oklab, Canvas 70%, transparent);padding:6px}
  .hint{font-size:12px;opacity:.8}
  .danger{color:#b00020}.ok{color:#0a7a27}
  dialog{max-width:720px;width:92%;border:none;border-radius:14px;padding:0 0 12px 0}
  dialog::backdrop{backdrop-filter:blur(2px)}
  .dlg-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent)}
  .dlg-bd{padding:12px 16px;line-height:1.6}
</style>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <div style="display:flex;gap:8px;align-items:center;">
    <h1 style="flex:1">PDFã‚¹ã‚­ãƒ£ãƒ³ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰</h1>
    <button id="helpBtn" style="width:auto;padding:8px 12px;">â“ä½¿ã„æ–¹</button>
    <button id="safeBtn" style="width:auto;padding:8px 12px;">ğŸ”’å®‰å¿ƒ</button>
  </div>
</header>

<div class="wrap">
  <div class="row">
    <button id="start">ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="shot"  disabled>ğŸ“· æ’®å½±</button>
    <button id="stop"  disabled>â–  åœæ­¢</button>
  </div>

  <input id="pick" type="file" accept="image/*" capture="environment" multiple />

  <video id="video" playsinline autoplay muted></video>

  <h3 style="margin:6px 0">ğŸ“‘ ãƒšãƒ¼ã‚¸</h3>
  <div id="thumbs" class="grid"></div>
  <div class="hint">é †ç•ªã¯â†‘â†“ã§å¤‰æ›´ã€å‰Šé™¤å¯ã€‚å¿…è¦æšæ•°ã‚’è¿½åŠ ã—ãŸã‚‰PDFã‚’ä½œæˆã€‚</div>

  <div class="row">
    <button id="clear" class="danger">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    <button id="make"  class="ok">ğŸ§¾ PDFä½œæˆ</button>
  </div>

  <div id="after" style="display:none;">
    <div class="hint">ä½œæˆã—ã¾ã—ãŸã€‚ä¿å­˜ã‚„å…±æœ‰ãŒã§ãã¾ã™ã€‚</div>
    <div class="row">
      <a id="dl" download class="ok" style="text-align:center;display:inline-block;padding:12px;border:1px solid;color:inherit;border-radius:12px;">â¬‡ï¸ ç«¯æœ«ã«ä¿å­˜</a>
      <button id="share">ğŸ¤ å…±æœ‰</button>
    </div>
  </div>

  <div id="toast" class="hint"></div>
</div>

<footer class="hint" style="padding:12px 16px;">A4/é•·è¾º2000px/å“è³ª0.8/ç™½é»’å¼·èª¿ï¼ˆæ—¢å®šï¼‰ã€‚ã™ã¹ã¦ç«¯æœ«å†…ã§å‡¦ç†ã—ã¾ã™ã€‚</footer>

<!-- ä½¿ã„æ–¹ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="dlg">
  <div class="dlg-hd"><strong>ä½¿ã„æ–¹</strong><button id="closeDlg" style="width:auto;padding:8px 12px;">âœ• é–‰ã˜ã‚‹</button></div>
  <div class="dlg-bd">
    <ol>
      <li><strong>ã‚«ãƒ¡ãƒ©èµ·å‹•</strong> â†’ æ›¸é¡ã‚’ç”»é¢ã„ã£ã±ã„ã«ã—ã¦ <em>æ’®å½±</em>ï¼ˆã¾ãŸã¯ç”»åƒã‚’é¸æŠï¼‰ã€‚</li>
      <li>å¿…è¦ãªãƒšãƒ¼ã‚¸ã‚’ <em>è¤‡æ•°è¿½åŠ </em>ã€‚ã‚µãƒ ãƒã® <em>â†‘â†“ã§é †ç•ªå¤‰æ›´</em>ãƒ»<em>å‰Šé™¤</em>ã§ãã¾ã™ã€‚</li>
      <li><strong>PDFä½œæˆ</strong> ã‚’æŠ¼ã™ã¨ã€A4ç¸¦ã®PDFã‚’ç«¯æœ«å†…ã§ç”Ÿæˆã—ã¾ã™ã€‚</li>
      <li><strong>ä¿å­˜</strong> ã§ç«¯æœ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚<strong>å…±æœ‰</strong> ã‹ã‚‰LINE/ãƒ¡ãƒ¼ãƒ«/Driveã¸é€ä¿¡å¯èƒ½ï¼ˆå¯¾å¿œç«¯æœ«ï¼‰ã€‚</li>
    </ol>
    <p><strong>ãƒ’ãƒ³ãƒˆ</strong>ï¼šæ˜ã‚‹ã„å ´æ‰€ã§æ’®ã‚‹ï¼ç”¨ç´™å…¨ä½“ã‚’å…¥ã‚Œã‚‹ï¼å½±ãŒå…¥ã£ãŸã‚‰æ’®ã‚Šç›´ã™ã€‚å€‹äººæƒ…å ±ã¯å…±æœ‰å‰ã«ã”ç¢ºèªãã ã•ã„ã€‚</p>
  </div>
</dialog>

<!-- å®‰å¿ƒã‚¬ã‚¤ãƒ‰ï¼ˆåˆå›ã¯è‡ªå‹•è¡¨ç¤ºï¼‰ -->
<dialog id="safeDlg">
  <div class="dlg-hd"><strong>å®‰å¿ƒã‚¬ã‚¤ãƒ‰</strong><button id="closeSafe" style="width:auto;padding:8px 12px;">OK</button></div>
  <div class="dlg-bd">
    <ul>
      <li><strong>ç«¯æœ«å†…ã§å®Œçµï¼š</strong> ç”»åƒå‡¦ç†ã¨PDFä½œæˆã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã„ã€ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã—ã¾ã›ã‚“ã€‚</li>
      <li><strong>è¨±å¯ãŒå¿…è¦ãªã®ã¯ã‚«ãƒ¡ãƒ©ã®ã¿ï¼š</strong> ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã‚ãªã„å ´åˆã¯ã€Œç”»åƒã‚’é¸æŠã€ã ã‘ã§OKã€‚</li>
      <li><strong>ã‚¹ãƒãƒ›ã®ç”»åƒOKï¼š</strong> JPG/PNG/WEBPã‚’ãã®ã¾ã¾PDFåŒ–ã€‚æœªå¯¾å¿œå½¢å¼ã¯ç«¯æœ«ã§JPGä¿å­˜ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</li>
      <li><strong>å…±æœ‰ã¯æ‰‹å‹•ã§ï¼š</strong> ã€Œä¿å­˜/å…±æœ‰ã€ã‚’æŠ¼ã—ãŸæ™‚ã ã‘ä»–ã‚¢ãƒ—ãƒªã¸æ¸¡ã‚Šã¾ã™ã€‚</li>
    </ul>
    <p class="hint">â€» ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èµ·å‹•ã‚„ãƒ›ãƒ¼ãƒ è¿½åŠ ã¯PWAåŒ–ï¼ˆService Worker è¿½åŠ ï¼‰ãŒå¿…è¦ã§ã™ã€‚</p>
  </div>
</dialog>

<script>
(() => {
  const { jsPDF } = window.jspdf;
  const $ = (id)=>document.getElementById(id);

  // UIå‚ç…§
  const start=$('start'), shot=$('shot'), stop=$('stop'), pick=$('pick'), video=$('video');
  const thumbs=$('thumbs'), clearBtn=$('clear'), makeBtn=$('make');
  const after=$('after'), dl=$('dl'), share=$('share'), toast=$('toast');
  const helpBtn=$('helpBtn'), dlg=$('dlg'), closeDlg=$('closeDlg');
  const safeBtn=$('safeBtn'), safeDlg=$('safeDlg'), closeSafe=$('closeSafe');

  // æ—¢å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const MAXPX=2000, QUALITY=0.8, BW=true;

  // çŠ¶æ…‹
  let pages=[]; let stream=null; let undo=null; let lastBlob=null; let lastName='scan_'+fmtDate()+'.pdf';

  // èª¬æ˜/å®‰å¿ƒ
  helpBtn.addEventListener('click', ()=>dlg.showModal());
  closeDlg.addEventListener('click', ()=>dlg.close());
  safeBtn.addEventListener('click', ()=>safeDlg.showModal());
  closeSafe.addEventListener('click', ()=>{ safeDlg.close(); localStorage.setItem('pdfscan_safety_seen','1'); });
  if(!localStorage.getItem('pdfscan_safety_seen')){ setTimeout(()=>safeDlg.showModal(), 250); }

  // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
  start.addEventListener('click', startCam);
  stop.addEventListener('click', ()=>{ stopCam(); toastMsg('ã‚«ãƒ¡ãƒ©åœæ­¢'); });
  window.addEventListener('beforeunload', stopCam);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCam(); });

  async function startCam(){
    stopCam();
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      video.srcObject=stream; shot.disabled=false; stop.disabled=false; toastMsg('ã‚«ãƒ¡ãƒ©èµ·å‹•');
    }catch(e){ console.error(e); toastMsg('ã‚«ãƒ¡ãƒ©ä¸å¯ã€‚ç”»åƒé¸æŠã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'); }
  }
  function stopCam(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null; shot.disabled=true; stop.disabled=true;
  }

  // æ’®å½±
  shot.addEventListener('click', ()=>{
    if(!stream) return;
    const vw=video.videoWidth||1920, vh=video.videoHeight||1080;
    const cv=document.createElement('canvas'); cv.width=vw; cv.height=vh;
    cv.getContext('2d').drawImage(video,0,0,vw,vh);
    addPage(cv);
  });

  // ç”»åƒå–è¾¼ã¿ï¼ˆEXIFå›è»¢â†’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  pick.addEventListener('change', async (e)=>{
    const files=[...e.target.files]; if(!files.length) return;
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      try{
        const bmp=await createImageBitmap(f,{imageOrientation:'from-image'});
        const cv=document.createElement('canvas'); cv.width=bmp.width; cv.height=bmp.height;
        cv.getContext('2d').drawImage(bmp,0,0); bmp.close?.();
        addPage(cv);
      }catch(err){
        try{
          const dataURL = await fileToDataURL(f);
          const img = await loadImage(dataURL);
          const cv=document.createElement('canvas'); cv.width=img.naturalWidth||img.width; cv.height=img.naturalHeight||img.height;
          cv.getContext('2d').drawImage(img,0,0);
          addPage(cv);
        }catch(e2){
          console.warn('unsupported image format', e2);
          toastMsg('ã“ã®ç”»åƒå½¢å¼ã¯æœªå¯¾å¿œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç«¯æœ«ã§JPG/PNGã«å¤‰æ›ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        }
      }
    }
  });

  // ãƒšãƒ¼ã‚¸è¿½åŠ ï¼ˆç¸®å°â†’ç™½é»’â†’JPEGåŒ–ï¼‰
  function addPage(srcCv){
    const scale=Math.min(1, MAXPX/Math.max(srcCv.width, srcCv.height));
    const w=Math.round(srcCv.width*scale), h=Math.round(srcCv.height*scale);
    const cv=document.createElement('canvas'); cv.width=w; cv.height=h; const ctx=cv.getContext('2d');
    ctx.drawImage(srcCv,0,0,w,h);
    if(BW){ const img=ctx.getImageData(0,0,w,h), d=img.data; for(let i=0;i<d.length;i+=4){ const y=d[i]*.299+d[i+1]*.587+d[i+2]*.114; d[i]=d[i+1]=d[i+2]=y; } ctx.putImageData(img,0,0); }
    pages.push(cv.toDataURL('image/jpeg', QUALITY));
    render(); toastMsg(`è¿½åŠ ï¼š${pages.length}ãƒšãƒ¼ã‚¸`);
  }

  // ã‚µãƒ ãƒæç”»/ä¸¦ã¹æ›¿ãˆ/å‰Šé™¤
  function render(){
    thumbs.innerHTML=''; after.style.display='none';
    pages.forEach((src,i)=>{
      const card=document.createElement('div'); card.className='card';
      const img=document.createElement('img'); img.src=src; card.appendChild(img);
      const bar=document.createElement('div'); bar.className='btns';
      const up =btn('â†‘',()=>{ if(i>0){ [pages[i-1],pages[i]]=[pages[i],pages[i-1]]; render(); } });
      const dn =btn('â†“',()=>{ if(i<pages.length-1){ [pages[i+1],pages[i]]=[pages[i],pages[i+1]]; render(); } });
      const del=btn('å‰Šé™¤',()=>{ undo={i,data:pages[i]}; pages.splice(i,1); render(); toastMsg('å‰Šé™¤ã—ã¾ã—ãŸ','å…ƒã«æˆ»ã™',undoDel); });
      bar.append(up,dn,del); card.appendChild(bar); thumbs.appendChild(card);
    });
  }
  function btn(t,on){ const b=document.createElement('button'); b.textContent=t; b.onclick=on; return b; }
  function undoDel(){ if(!undo) return; pages.splice(undo.i,0,undo.data); undo=null; render(); }

  // å…¨å‰Šé™¤
  clearBtn.addEventListener('click',()=>{ if(!pages.length) return; if(confirm('ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ pages=[]; render(); toastMsg('å…¨å‰Šé™¤'); } });

  // PDFä½œæˆï¼ˆA4ç¸¦ / ä½™ç™½24pt / ãƒšãƒ¼ã‚¸ç•ªå·ï¼‰
  makeBtn.addEventListener('click', async ()=>{
    if(!pages.length){ toastMsg('ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const size=[595.28,841.89]; // A4 pt
    const pdf=new jsPDF({orientation:'p', unit:'pt', format:size});
    const margin=24, W=size[0]-margin*2, H=size[1]-margin*2;

    for(let i=0;i<pages.length;i++){
      if(i>0) pdf.addPage(size,'p');
      const {w:iw,h:ih}=await imgSize(pages[i]);
      const ir=iw/ih, wr=W/H; let dw,dh; if(ir>wr){ dw=W; dh=W/ir; } else { dh=H; dw=H*ir; }
      const x=(size[0]-dw)/2, y=(size[1]-dh)/2;
      pdf.addImage(pages[i],'JPEG',x,y,dw,dh,undefined,'FAST');
      pdf.setFontSize(10); pdf.text(`${i+1}/${pages.length}`, size[0]-margin, size[1]-margin*0.6, {align:'right'});
    }
    lastName = 'scan_'+fmtDate()+'.pdf';
    lastBlob = pdf.output('blob');
    const url=URL.createObjectURL(lastBlob);
    dl.href=url; dl.download=lastName; after.style.display='block';

    pdf.save(lastName);
    stopCam(); // ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„
    toastMsg('PDFã‚’ä½œæˆã—ã¾ã—ãŸ');
  });

  // å…±æœ‰ï¼ˆWeb Shareå¯¾å¿œç«¯æœ«ï¼‰
  share.addEventListener('click', async ()=>{
    if(!lastBlob){ toastMsg('å…ˆã«PDFã‚’ä½œæˆã—ã¦ãã ã•ã„'); return; }
    const file=new File([lastBlob], lastName, {type:'application/pdf'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:lastName, files:[file]});
    }else{ toastMsg('ã“ã®ç«¯æœ«ã¯Web Shareæœªå¯¾å¿œã§ã™ã€‚ä¿å­˜ã—ã¦ã‹ã‚‰å…±æœ‰ã—ã¦ãã ã•ã„ã€‚'); }
  });

  // è£œåŠ©
  function fmtDate(d=new Date()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}${m}${da}`; }
  function imgSize(url){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth||1,h:img.naturalHeight||1}); img.src=url; }); }
  function toastMsg(text, actionText, action){ toast.textContent=''; toast.append(document.createTextNode(text)); if(actionText){ const b=document.createElement('button'); b.textContent=actionText; b.style.marginLeft='8px'; b.onclick=()=>{ action?.(); toast.textContent=''; }; toast.appendChild(b);} }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; }); }
})();
</script>
</body>
</html>
