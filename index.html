<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PDFスキャン｜カメラとファイルを使い分け＋OCR</title>
<style>
  :root { color-scheme: light dark; --gap:12px; }
  *{ box-sizing:border-box }
  html,body{ max-width:100%; overflow-x:hidden }
  body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0 }
  header,.wrap,footer{ max-width:720px; margin-inline:auto }
  header{ position:sticky; top:0; z-index:10; padding:12px 16px;
          background:color-mix(in oklab, Canvas 85%, transparent);
          backdrop-filter:blur(6px);
          border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent) }
  h1{ margin:0; font-size:18px }
  .wrap{ padding:16px; display:grid; gap:var(--gap) }
  button,input[type=file]{ padding:12px; font-size:16px; border-radius:12px;
    border:1px solid color-mix(in oklab, CanvasText 15%, transparent);
    width:100%; background:color-mix(in oklab, Canvas 92%, transparent) }
  .row{ display:grid; gap:var(--gap); grid-template-columns:1fr 1fr 1fr }
  @media (max-width:640px){ .row{ grid-template-columns:1fr } }
  video{ width:100%; max-height:42vh; object-fit:cover; border-radius:12px; background:#000 }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:8px }
  .card{ position:relative; border:1px solid color-mix(in oklab, CanvasText 15%, transparent);
         border-radius:10px; overflow:hidden }
  .card img{ width:100%; height:120px; object-fit:cover; display:block }
  .card .btns{ position:absolute; inset:auto 0 0 0; display:flex; gap:6px; justify-content:center;
               background:color-mix(in oklab, Canvas 70%, transparent); padding:6px }
  .hint{ font-size:12px; opacity:.8 }
  .danger{ color:#b00020 } .ok{ color:#0a7a27 }
  label.tog{ display:block; font-size:14px; }
</style>
<!-- PDF生成 -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- OCR（初回は言語データの読み込みが入ります） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1>PDFスキャン（カメラ／ファイル使い分け＋OCR）</h1>
</header>

<div class="wrap">
  <!-- カメラ操作 -->
  <div class="row">
    <button id="start">🎥 カメラ起動</button>
    <button id="stop"  disabled>■ 停止</button>
    <button id="shot"  disabled>📷 撮影</button>
  </div>

  <!-- ファイル選択（ギャラリー専用） -->
  <button id="choose">🖼 画像を選ぶ</button>
  <input id="pick" type="file" accept="image/*" multiple style="display:none" />

  <!-- 出力オプション -->
  <label class="tog"><input id="bw" type="checkbox" checked> 白黒で軽量化（OFFでカラー）</label>
  <label class="tog"><input id="ocr" type="checkbox"> 文字を検索/選択可にする（OCR：日本語+英語 β）</label>

  <video id="video" playsinline autoplay muted></video>

  <h3 style="margin:6px 0">📑 ページ</h3>
  <div id="thumbs" class="grid"></div>
  <div class="hint">↑↓で順番変更、削除可。必要枚数を追加したらPDF作成へ。</div>

  <div class="row">
    <button id="clear" class="danger">🗑️ 全削除</button>
    <button id="make"  class="ok">🧾 PDF作成</button>
  </div>

  <div id="after" style="display:none;">
    <div class="hint">作成しました。保存や共有ができます。</div>
    <div class="row">
      <a id="dl" download class="ok" style="text-align:center;display:inline-block;padding:12px;border:1px solid;color:inherit;border-radius:12px;">⬇️ 端末に保存</a>
      <button id="share">🤝 共有</button>
    </div>
  </div>

  <div id="toast" class="hint"></div>
</div>

<footer class="hint" style="padding:12px 16px;">
  ※ カメラは HTTPS ページでのみ利用可（GitHub Pages など推奨）。OCRは初回に言語データの取得が必要です。
</footer>

<script>
(() => {
  const { jsPDF } = window.jspdf;
  const $ = (id)=>document.getElementById(id);

  // UI参照
  const start=$('start'), stop=$('stop'), shot=$('shot');
  const choose=$('choose'), pick=$('pick'), video=$('video');
  const thumbs=$('thumbs'), clearBtn=$('clear'), makeBtn=$('make');
  const after=$('after'), dl=$('dl'), share=$('share'), toast=$('toast');
  const bwChk=$('bw'), ocrChk=$('ocr');

  // 既定パラメータ
  const MAXPX=2000, QUALITY=0.8; // A4向けの軽量バランス
  const isBW = () => bwChk.checked;

  // 状態
  let pages=[]; let stream=null; let undo=null; let lastBlob=null; let lastName='scan_'+fmtDate()+'.pdf';

  // カメラ制御
  start.addEventListener('click', startCam);
  stop.addEventListener('click', ()=>{ stopCam(); toastMsg('カメラ停止'); });
  shot.addEventListener('click', ()=>{ if(!stream) return; captureFrame(); });
  window.addEventListener('beforeunload', stopCam);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCam(); });

  async function startCam(){
    stopCam();
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      video.srcObject=stream; shot.disabled=false; stop.disabled=false; toastMsg('カメラ起動');
    }catch(e){ console.error(e); toastMsg('カメラ不可。画像を選んでください。'); }
  }
  function stopCam(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null; shot.disabled=true; stop.disabled=true;
  }
  function captureFrame(){
    const vw=video.videoWidth||1920, vh=video.videoHeight||1080;
    const cv=document.createElement('canvas'); cv.width=vw; cv.height=vh;
    cv.getContext('2d').drawImage(video,0,0,vw,vh);
    addPage(cv);
  }

  // ファイル選択：まず File Picker API（対応端末）→ 非対応は input にフォールバック
  choose.addEventListener('click', async ()=>{
    if ('showOpenFilePicker' in window) {
      try {
        const handles = await window.showOpenFilePicker({
          multiple: true,
          types: [{ description:'Images', accept:{ 'image/*': ['.png','.jpg','.jpeg','.webp','.heic','.heif'] } }]
        });
        const files = await Promise.all(handles.map(h => h.getFile()));
        await addFiles(files);
        return;
      } catch(e){ /* ユーザーキャンセル等 → inputで */ }
    }
    pick.click();
  });
  pick.addEventListener('change', async (e)=>{
    await addFiles([...e.target.files]);
    e.target.value = ''; // 同じ画像の再選択でもchange発火
  });

  async function addFiles(files){
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      try{
        const bmp=await createImageBitmap(f,{ imageOrientation:'from-image' }); // EXIF対応
        const cv=document.createElement('canvas'); cv.width=bmp.width; cv.height=bmp.height;
        cv.getContext('2d').drawImage(bmp,0,0); bmp.close?.();
        addPage(cv);
      }catch(err){
        // フォールバック（HEIC等）：FileReader→Image で試行
        try{
          const dataURL = await fileToDataURL(f);
          const img = await loadImage(dataURL);
          const cv=document.createElement('canvas'); cv.width=img.naturalWidth||img.width; cv.height=img.naturalHeight||img.height;
          cv.getContext('2d').drawImage(img,0,0);
          addPage(cv);
        }catch(e2){
          console.warn('unsupported image format', e2);
          toastMsg('この画像形式は未対応の可能性があります。端末でJPG/PNGに変換して再試行してください。');
        }
      }
    }
  }

  // ページ化（縮小→白黒オプション→JPEG化）
  function addPage(srcCv){
    const scale=Math.min(1, MAXPX/Math.max(srcCv.width, srcCv.height));
    const w=Math.round(srcCv.width*scale), h=Math.round(srcCv.height*scale);
    const cv=document.createElement('canvas'); cv.width=w; cv.height=h; const ctx=cv.getContext('2d');
    ctx.drawImage(srcCv,0,0,w,h);
    if(isBW()){ // 軽量グレースケール
      const img=ctx.getImageData(0,0,w,h), d=img.data;
      for(let i=0;i<d.length;i+=4){ const y=d[i]*.299+d[i+1]*.587+d[i+2]*.114; d[i]=d[i+1]=d[i+2]=y; }
      ctx.putImageData(img,0,0);
    }
    pages.push(cv.toDataURL('image/jpeg', QUALITY));
    render(); toastMsg(`追加：${pages.length}ページ`);
  }

  // サムネ描画/並べ替え/削除
  function render(){
    thumbs.innerHTML=''; after.style.display='none';
    pages.forEach((src,i)=>{
      const card=document.createElement('div'); card.className='card';
      const img=document.createElement('img'); img.src=src; card.appendChild(img);
      const bar=document.createElement('div'); bar.className='btns';
      const up =btn('↑',()=>{ if(i>0){ [pages[i-1],pages[i]]=[pages[i],pages[i-1]]; render(); } });
      const dn =btn('↓',()=>{ if(i<pages.length-1){ [pages[i+1],pages[i]]=[pages[i],pages[i+1]]; render(); } });
      const del=btn('削除',()=>{ undo={i,data:pages[i]}; pages.splice(i,1); render(); toastMsg('削除しました','元に戻す',undoDel); });
      bar.append(up,dn,del); card.appendChild(bar); thumbs.appendChild(card);
    });
  }
  function btn(t,on){ const b=document.createElement('button'); b.textContent=t; b.onclick=on; return b; }
  function undoDel(){ if(!undo) return; pages.splice(undo.i,0,undo.data); undo=null; render(); }

  // 全削除
  clearBtn.addEventListener('click',()=>{
    if(!pages.length) return;
    if(confirm('すべて削除しますか？')){ pages=[]; render(); toastMsg('全削除'); }
  });

  // PDF作成（A4縦 / 余白24pt / ページ番号＋OCRオプション）
  makeBtn.addEventListener('click', async ()=>{
    if(!pages.length){ toastMsg('ページがありません'); return; }
    const size=[595.28,841.89]; // A4 pt
    const pdf=new jsPDF({orientation:'p', unit:'pt', format:size});
    const margin=24, W=size[0]-margin*2, H=size[1]-margin*2;

    for(let i=0;i<pages.length;i++){
      if(i>0) pdf.addPage(size,'p');

      // 画像配置（中央・最大）
      const {w:iw,h:ih}=await imgSize(pages[i]);
      const ir=iw/ih, wr=W/H; let dw,dh;
      if(ir>wr){ dw=W; dh=W/ir; } else { dh=H; dw=H*ir; }
      const x=(size[0]-dw)/2, y=(size[1]-dh)/2;
      pdf.addImage(pages[i],'JPEG',x,y,dw,dh,undefined,'FAST');

      // ページ番号
      pdf.setFontSize(10);
      pdf.text(`${i+1}/${pages.length}`, size[0]-margin, size[1]-margin*0.6, {align:'right'});

      // OCR（任意）：透明レイヤー代わりに白文字で重ねる（見た目は変わらず、選択/検索可）
      if(ocrChk.checked && window.Tesseract){
        try{
          const { data } = await Tesseract.recognize(pages[i], 'jpn+eng');
          const words = data.words || [];
          const scaleX = dw / iw, scaleY = dh / ih;
          pdf.setTextColor(255,255,255); // 白背景で不可視
          pdf.setFontSize(10);
          for(const wd of words){
            const b = wd.bbox || wd; // safety
            const tx = x + (b.x0 || b.x) * scaleX;
            const ty = y + (b.y1 || (b.y + b.h)) * scaleY; // 下端基準
            const t  = wd.text || wd.symbol || '';
            if(t) pdf.text(t, tx, ty, { baseline:'bottom' });
          }
        }catch(e){
          console.warn('OCR failed', e);
          toastMsg('OCRに失敗しました（通信状況や画像を確認してください）');
        }
      }
    }

    lastName = 'scan_'+fmtDate()+'.pdf';
    lastBlob = pdf.output('blob');
    const url=URL.createObjectURL(lastBlob);
    dl.href=url; dl.download=lastName; after.style.display='block';

    pdf.save(lastName);
    stopCam(); // バッテリー節約
    toastMsg('PDFを作成しました');
  });

  // 共有（Web Share対応端末）
  share.addEventListener('click', async ()=>{
    if(!lastBlob){ toastMsg('先にPDFを作成してください'); return; }
    const file=new File([lastBlob], lastName, {type:'application/pdf'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:lastName, files:[file]});
    }else{ toastMsg('この端末はWeb Share未対応です。保存してから共有してください。'); }
  });

  // 補助
  function fmtDate(d=new Date()){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
    return `${y}${m}${da}`;
  }
  function imgSize(url){
    return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth||1,h:img.naturalHeight||1}); img.src=url; });
  }
  function toastMsg(text, actionText, action){
    toast.textContent=''; toast.append(document.createTextNode(text));
    if(actionText){ const b=document.createElement('button'); b.textContent=actionText; b.style.marginLeft='8px'; b.onclick=()=>{ action?.(); toast.textContent=''; }; toast.appendChild(b); }
  }
  function fileToDataURL(file){
    return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  }
  function loadImage(src){
    return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; });
  }
})();
</script>
</body>
</html>
